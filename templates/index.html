<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Training Visualization</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 20px;
        }
        .image-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
        }
        .image-item {
            width: 45%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .image-item img {
            max-width: 100%;
            height: auto;
        }
        .image-item p {
            margin: 5px 0;
            font-size: 16px;
            color: #555;
        }
        #chart-container {
            width: 90%;
            margin: 20px auto;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Training Visualization</h1>

    <div id="chart-container">
        <canvas id="loss-chart"></canvas>
    </div>
    <div id="chart-container">
        <canvas id="point-num-chart"></canvas>
    </div>

    <div id="image-container" class="image-grid">
        <p>No images yet. Waiting for updates...</p>
    </div>
    <canvas id="canvas" style="display: none;"></canvas>

    <script>
        const socket = io();
        const imageContainer = document.getElementById("image-container");
        const ctx_loss = document.getElementById("loss-chart").getContext("2d");
        const ctx_point_num = document.getElementById("point-num-chart").getContext("2d");

        // 初始化 Chart.js 图表
        let chart_loss;
        let chart_point_num;
        let iterationCount = 0; // 记录当前的迭代次数
        let iterationCount2 = 0;
        


        // 监听新图片推送
        socket.on("update_image", (data) => {
            const existingImage = document.querySelector(`img[data-path="${data.image_path}"]`);

            const newImage = new Image();
            newImage.src = data.image_path + "?t=" + new Date().getTime();

            if (existingImage) {
                existingImage.src = newImage.src;
            } else {
                if (imageContainer.children.length === 1 && imageContainer.children[0].tagName === "P") {
                    imageContainer.innerHTML = "";
                }

                const imageItem = document.createElement("div");
                imageItem.className = "image-item";

                const imgElement = document.createElement("img");
                imgElement.src = newImage.src;
                imgElement.setAttribute("data-path", data.image_path);

                const nameElement = document.createElement("p");
                nameElement.textContent = data.image_name;

                imageItem.appendChild(imgElement);
                imageItem.appendChild(nameElement);
                imageContainer.appendChild(imageItem);
            }
        });     


        // 监听 Loss 数据推送
        socket.on("update_loss", (data) => {
            const labels = data.labels; // 数据标签（如 l1, l2, l3）
            const lossData = data.data; // 每行的迭代结果

            // 确定新数据的索引范围
            const newIterations = lossData.slice(iterationCount); // 仅处理新增的行
            iterationCount = lossData.length; // 更新迭代次数

            // 如果是第一次加载，初始化图表
            if (!chart_loss) {
                // 准备 datasets
                const datasets = labels.map((label, idx) => ({
                    label: label,
                    data: newIterations.map((row) => row[idx]), // 初始化的第一批数据
                    borderColor: `hsl(${(idx * 360) / labels.length}, 70%, 50%)`,
                    fill: false,
                }));

                const xLabels = Array.from({ length: lossData.length }, (_, i) => i + 1);

                chart_loss = new Chart(ctx_loss, {
                    type: "line",
                    data: {
                        labels: xLabels, // 横轴初始标签
                        datasets: datasets,
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: "Iteration",
                                },
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: "Loss Value",
                                },
                            },
                        },
                    }
                });
            } else {
                // 动态更新已有图表
                newIterations.forEach((row, idx) => {
                    const newIndex = iterationCount - newIterations.length + idx + 1;

                    // 添加新的 x 轴标签
                    chart_loss.data.labels.push(newIndex);

                    // 更新每条折线的数据
                    chart_loss.data.datasets.forEach((dataset, datasetIdx) => {
                        dataset.data.push(row[datasetIdx]);
                    });
                });

                // 更新图表显示
                chart_loss.update();
            }
        });

        socket.on("update_point_num", (data) => {
            const labels = data.labels; // 数据标签（如 l1, l2, l3）
            const _data = data.data; // 每行的迭代结果

            // 确定新数据的索引范围
            const newIterations = _data.slice(iterationCount2); // 仅处理新增的行
            iterationCount2 = _data.length;

            // 如果是第一次加载，初始化图表
            if (!chart_point_num) {
                // 准备 datasets
                const datasets = labels.map((label, idx) => ({
                    label: label,
                    data: newIterations.map((row) => row[idx]), // 初始化的第一批数据
                    borderColor: `hsl(${(idx * 360) / labels.length}, 70%, 50%)`,
                    fill: false,
                }));

                const xLabels = Array.from({ length: _data.length }, (_, i) => i + 1);

                chart_point_num = new Chart(ctx_point_num, {
                    type: "line",
                    data: {
                        labels: xLabels, // 横轴初始标签
                        datasets: datasets,
                    },
                    options: {
                        responsive: true,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: "Iteration",
                                },
                            },
                            y: {
                                title: {
                                    display: true,
                                    text: "Loss Value",
                                },
                            },
                        },
                    }
                });
            } else {
                // 动态更新已有图表
                newIterations.forEach((row, idx) => {
                    const newIndex = iterationCount2 - newIterations.length + idx + 1;

                    // 添加新的 x 轴标签
                    chart_point_num.data.labels.push(newIndex);

                    // 更新每条折线的数据
                    chart_point_num.data.datasets.forEach((dataset, datasetIdx) => {
                        dataset.data.push(row[datasetIdx]);
                    });
                });

                // 更新图表显示
                chart_point_num.update();
            }
        });
    </script>
</body>
</html>

